#!/usr/bin/env bash

set -o pipefail -o errexit -o nounset

lock=$(realpath "$1")
autofix=${{2:-}}

cd "$BUILD_WORKING_DIRECTORY"

echo
echo "Writing lockfile to {workspace_relative_path}"
cp "$lock" "{workspace_relative_path}"

# Detect a vendored buildozer binary in canonical location (tools/buildozer)
if [ -e "$BUILD_WORKSPACE_DIRECTORY/tools/buildozer" ]; then
    buildozer="./tools/buildozer"
else
    # Assume it's on the $PATH
    buildozer="buildozer"
fi

echo

cat <<EOF
Run the following command to add the 'lock' attribute
to the "@{repo_name}" repo in MODULE.bazel:

$buildozer 'set lock "{lock_label}"' MODULE.bazel:{repo_name}
EOF
